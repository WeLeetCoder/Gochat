<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
    function qs(datas) {
        if (Object.prototype.toString.call(datas) === '[object String]' || Object.prototype.toString.call(datas) === '[object FormData]' || !datas) return datas;

        let queryStr = [];
        for (let data in datas) {
            if (datas.hasOwnProperty(data) && Object.prototype.toString.call(data) === '[object String]') {
                queryStr.push(`${ data }=${ datas[data] }`)
            }
        }

        return queryStr.join('&');
    }

    function ajax(request) {
        let url = request.url;
        let method = Object.prototype.toString.call(request.method) === '[object String]' ? request.method : 'POST';
        let data = Object.prototype.toString.call(request.data) === '[object String]' ? request.data : qs(request.data);
        let events = request.events;
        let xhr = new XMLHttpRequest();
        let headers = request.headers;
        return new Promise((resolve, reject) => {

            xhr.open(method, url, true);

            xhr.responseType = request.responseType ? request.responseType  : '';

            if (headers) {
                if (Object.prototype.toString.call(headers) === '[object Object]') {
                    for (let header in headers) {
                        if (headers.hasOwnProperty(header)) {
                            xhr.setRequestHeader(header, request.headers[header]);
                        }
                    }
                }
            }

            if (events) {
                if (Object.prototype.toString.call(events) === '[object Object]') {
                    for (let event in events) {
                        if (events.hasOwnProperty(event) && event !== 'upload') {
                            xhr.addEventListener(event, events[event], false);
                        }
                    }

                    for (let event in events.upload) {
                        if (events.upload.hasOwnProperty(event)) {
                            xhr.upload.addEventListener(event, events.upload[event], false);
                        }
                    }
                }
            }

            xhr.withCredentials = request.withCredentials !== undefined ? Boolean(request.withCredentials) : true;


            /**
             * xhr 5 个状态：
             * 0： UNSEND
             * 1： OPENED
             * 2： HEADERS_RECEIVED
             * 3： LOADING
             * 4： DONE
             *
             * xhr 事件触发顺序如下：
             * 1. onloadstart
             * 2. upload.onloadstart
             * 3. upload.onload
             * 4. upload.onloadend
             * 5. onreadystatechange -> readystatus == 2
             * 6. onreadystatechange -> readystatus == 3
             * 7. onreadystatechange -> readystatus == 4
             * 8. onload
             * 9. onloadend
             * @param e
             */
            // xhr.onreadystatechange = (e) => {
            //     console.log('onreadystartchange');
            //     console.log(xhr.readyState);
            // };
            // xhr.onloadstart = (e) => {
            //     console.log('loadstart')
            // };
            // xhr.upload.onloadstart = (e) => {
            //     console.log('upload onloadstart');
            // };
            // xhr.upload.onload = e => {
            //     console.log('upload onload');
            // };
            // xhr.upload.onloadend = e => {
            //     console.log('upload onloadend');
            // };
            // xhr.onprogress = e => {
            //     console.log(e, 'onprogress');
            // };
            // xhr.upload.addEventListener('progress', e => console.log(e.loaded/e.total), false);
            xhr.addEventListener('load', function (e) {
                if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304) {
                    resolve(xhr.response);
                } else {
                    reject(xhr);
                }
            }, false);

            xhr.send(data);

            return xhr;
        });
    }
    function wsConnect(username, roomname, token) {
        wsUrl = 'ws://localhost:5000/chat';
        wsConn = new WebSocket(wsUrl);
        wsConn.addEventListener('open', (e) => {
            wsConn.send(JSON.stringify({
                username,
                roomname,
                token
            }));
            console.log("open", e)
        }, false);
        wsConn.addEventListener('error', (e) => {
            console.log("error", e)
        }, false);
        wsConn.addEventListener('message', (e) => {
            console.log("message", e)
        }, false);
        wsConn.addEventListener('close', (e) => {
            console.log("close", e)
        }, false);
    }

    function Conn(username, rname) {
        xhr = ajax({
            url: 'http://localhost:5000/join',
            headers: {
                "content-type": 'application/x-www-form-urlencoded'
            },
            data: {
                username,
                rname
            }
        }).then((res) => {
            wsConnect(username, rname);
        });
    }
    (() => {
        tk = '5ce515884b435c5c9e86403cc1d474c6';
        username = "zhongqi2";
        rname = "test1";
        wsConnect(username, rname, tk)
    })()
</script>
</body>
</html>